#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start Trilium Next
# ==============================================================================

bashio::log.info "Starting Trilium Next..."

# Create data directory structure with proper permissions
bashio::log.info "Setting up data directory..."
mkdir -p /share/trilium/tmp
mkdir -p /share/trilium/document-store
mkdir -p /share/trilium/backup

# Set ownership to the node user (1000:1000)
chown -R 1000:1000 /share/trilium
chmod -R 755 /share/trilium

# Export environment variables from options
export NO_AUTHENTICATION=$(bashio::config 'NO_AUTHENTICATION')
export TRILIUM_OAUTH_BASE_URL=$(bashio::config 'TRILIUM_OAUTH_BASE_URL')
export TRILIUM_OAUTH_CLIENT_ID=$(bashio::config 'TRILIUM_OAUTH_CLIENT_ID')
export TRILIUM_OAUTH_CLIENT_SECRET=$(bashio::config 'TRILIUM_OAUTH_CLIENT_SECRET')
export TRILIUM_OAUTH_ISSUER_BASE_URL=$(bashio::config 'TRILIUM_OAUTH_ISSUER_BASE_URL')
export TRILIUM_OAUTH_ISSUER_NAME=$(bashio::config 'TRILIUM_OAUTH_ISSUER_NAME')

bashio::log.info "Data directory setup complete"
bashio::log.info "Starting Trilium Next application..."

# Start the application as user 1000
exec s6-setuidgid 1000:1000 node /usr/src/app/main.cjs
